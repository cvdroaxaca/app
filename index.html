<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tierra de Agaves | Trazabilidad Viva</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- CORE VISUAL SYSTEM --- */
        :root {
            --primary: #4CAF50; /* Verde Ecología */
            --secondary: #81C784;
            --accent: #FFD700; /* Oro Agave */
            --danger: #FF5252;
            --dark-bg: #050505;
            --glass: rgba(10, 20, 10, 0.85);
            --border: rgba(255, 255, 255, 0.15);
            --text-main: #E0E0E0;
            --panel-collapsed: 140px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; padding: 0; 
            background: var(--dark-bg); 
            font-family: 'Rajdhani', sans-serif; 
            overflow: hidden; 
            height: 100dvh; width: 100vw;
            color: var(--text-main);
        }

        /* --- MAPA & AMBIENTE --- */
        #map-container { position: absolute; inset: 0; z-index: 1; transition: filter 1s ease; }
        #map { width: 100%; height: 100%; }
        
        /* Efectos de Estación (CSS Filters son más rápidos que recargar tiles) */
        .season-dry #map-container { filter: sepia(0.6) contrast(1.1) brightness(0.9); }
        .season-wet #map-container { filter: sepia(0) contrast(1.0) brightness(1.0) saturate(1.2); }

        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 2;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);
        }

        /* --- ESCÁNER AR (SIMULADO) --- */
        #ar-overlay {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .scanner-reticle {
            width: 250px; height: 250px; border: 2px solid var(--primary);
            position: relative; border-radius: 20px;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
        .scanner-line {
            width: 100%; height: 2px; background: var(--accent);
            position: absolute; top: 0;
            animation: scanMove 2s infinite linear;
            box-shadow: 0 0 10px var(--accent);
        }
        .scan-data {
            margin-top: 20px; font-family: 'Cinzel'; color: var(--accent);
            text-align: center; opacity: 0;
        }
        @keyframes scanMove { 0% {top:0} 50% {top:100%} 100% {top:0} }

        /* --- UI FLOTANTE SUPERIOR --- */
        .top-ui {
            position: absolute; top: 0; left: 0; right: 0; padding: 20px; z-index: 10;
            display: flex; justify-content: space-between; align-items: flex-start;
            pointer-events: none;
        }
        .ui-btn {
            pointer-events: auto; background: var(--glass); 
            border: 1px solid var(--border); backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 30px; 
            color: white; font-weight: 600; font-size: 0.8rem;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
            transition: all 0.3s;
        }
        .ui-btn:active { transform: scale(0.95); }
        .ui-btn.active { border-color: var(--accent); color: var(--accent); }

        .stat-badge {
            text-align: right; background: rgba(0,0,0,0.6); 
            padding: 8px 12px; border-radius: 12px; border-right: 3px solid var(--accent);
            pointer-events: auto;
        }
        .stat-val { font-size: 1.2rem; font-weight: 700; color: white; display: block; font-family: 'Cinzel'; }
        .stat-lbl { font-size: 0.6rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* --- SMART DOCK (PANEL INFERIOR) --- */
        .smart-dock {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: var(--panel-collapsed);
            background: var(--glass);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            border-radius: 24px 24px 0 0;
            z-index: 50;
            transition: height 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .smart-dock.expanded { height: 75dvh; }

        /* Drag Handle */
        .dock-handle {
            width: 100%; height: 20px; display: flex; justify-content: center; align-items: center;
            cursor: pointer;
        }
        .bar { width: 40px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }

        /* Header del Panel */
        .dock-header {
            padding: 0 20px; flex-shrink: 0;
        }
        .dock-nav {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .nav-btn { font-size: 1.5rem; padding: 10px; color: #666; transition: 0.2s; cursor: pointer; }
        .nav-btn:hover, .nav-btn:active { color: var(--accent); }
        
        .loc-title { text-align: center; flex: 1; }
        .loc-cat { font-size: 0.7rem; color: var(--primary); letter-spacing: 2px; text-transform: uppercase; display: block; font-weight: 700; }
        .loc-name { font-family: 'Cinzel'; font-size: 1.4rem; margin: 0; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* Contenido Scrolleable */
        .dock-content {
            flex: 1; overflow-y: auto; padding: 10px 20px 40px 20px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .smart-dock.expanded .dock-content { opacity: 1; pointer-events: auto; }

        /* Tarjetas de Datos */
        .data-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px; padding: 15px; margin-bottom: 15px;
        }
        .card-title { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        /* Grid de Indicadores */
        .pill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .pill-item { 
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; 
            display: flex; align-items: center; gap: 8px; font-size: 0.8rem;
        }
        .pill-icon { width: 24px; height: 24px; border-radius: 50%; background: #333; display: flex; justify-content: center; align-items: center; color: var(--accent); font-size: 0.7rem; }

        /* COMPARADOR SLIDER (Monocultivo vs Policultivo) */
        .comparison-container {
            position: relative; width: 100%; height: 200px;
            border-radius: 12px; overflow: hidden; margin: 20px 0;
            border: 1px solid var(--border);
        }
        .img-comp { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .img-overlay {
            position: absolute; top: 0; left: 0; width: 50%; height: 100%;
            overflow: hidden; border-right: 2px solid white; box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            transition: width 0.1s;
        }
        .comp-label {
            position: absolute; bottom: 10px; padding: 4px 8px; background: rgba(0,0,0,0.7);
            color: white; font-size: 0.7rem; border-radius: 4px; pointer-events: none;
        }
        .comp-label.left { left: 10px; color: var(--danger); }
        .comp-label.right { right: 10px; color: var(--primary); }
        
        /* Slider Handle invisble para el touch */
        .slider-range {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: ew-resize; z-index: 10;
        }

        /* Botones de Acción */
        .btn-action {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1rem;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            cursor: pointer; margin-bottom: 10px;
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), #2E7D32); 
            color: white; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border); }

        /* MODALES */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100;
            display: none; flex-direction: column; opacity: 0; transition: opacity 0.3s;
        }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Radar Animado */
        .radar-box {
            width: 280px; height: 280px; border: 1px solid var(--primary); border-radius: 50%;
            position: relative; background: radial-gradient(rgba(0,50,0,0.2), transparent 70%);
            display: flex; justify-content: center; align-items: center;
        }
        .radar-box::after {
            content:''; position: absolute; inset: 10px; border: 1px dashed rgba(76,175,80,0.3); border-radius: 50%;
        }
        .radar-scan {
            position: absolute; width: 50%; height: 2px; background: linear-gradient(90deg, transparent, var(--primary));
            top: 50%; left: 50%; transform-origin: 0 0; animation: radarSpin 3s infinite linear;
        }
        @keyframes radarSpin { 100% { transform: rotate(360deg); } }

        /* Utility */
        .hidden { display: none; }
    </style>
</head>
<body class="season-wet">

    <div id="ar-overlay">
        <div class="scanner-reticle">
            <div class="scanner-line"></div>
        </div>
        <div class="scan-data" id="scan-text">
            <p>DETECTANDO LOTE...</p>
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
    </div>
    <div class="vignette"></div>

    <div class="top-ui">
        <button class="ui-btn" id="season-btn" onclick="toggleSeason()">
            <i class="fas fa-cloud-showers-heavy" id="season-icon"></i> 
            <span id="season-txt">LLUVIAS</span>
        </button>
        
        <div class="stat-badge">
            <span class="stat-val counter" data-target="1150">0</span>
            <span class="stat-lbl">Hectáreas Protegidas</span>
        </div>
    </div>

    <div class="smart-dock" id="dock">
        <div class="dock-handle" onclick="toggleDock()">
            <div class="bar"></div>
        </div>

        <div class="dock-header">
            <div class="dock-nav">
                <i class="fas fa-chevron-left nav-btn" onclick="changeLocation(-1)"></i>
                <div class="loc-title" onclick="toggleDock()">
                    <span class="loc-cat" id="d-cat">CATEGORÍA</span>
                    <h2 class="loc-name" id="d-name">Nombre</h2>
                </div>
                <i class="fas fa-chevron-right nav-btn" onclick="changeLocation(1)"></i>
            </div>
            <div style="display:flex; align-items:center; gap:10px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); cursor:pointer;" onclick="playAudio()">
                <div style="width:30px; height:30px; border-radius:50%; background:var(--accent); display:flex; justify-content:center; align-items:center; color:black;">
                    <i class="fas fa-play" id="play-icon"></i>
                </div>
                <div style="font-size:0.8rem; color:#ccc;">Historia Oral: <strong style="color:white;" id="d-audio">Título Audio</strong></div>
            </div>
        </div>

        <div class="dock-content">
            
            <p style="line-height:1.6; color:#ccc; margin-top:0;" id="d-desc">Descripción...</p>

            <div class="data-card">
                <div class="card-title"><span>Signos Vitales</span> <i class="fas fa-heartbeat"></i></div>
                <div class="pill-grid">
                    <div class="pill-item"><div class="pill-icon"><i class="fas fa-tint"></i></div> <span id="val-water">Infiltración Alta</span></div>
                    <div class="pill-item"><div class="pill-icon"><i class="fas fa-leaf"></i></div> <span id="val-veg">Cobertura 85%</span></div>
                    <div class="pill-item"><div class="pill-icon"><i class="fas fa-paw"></i></div> <span id="val-fauna">Fauna Activa</span></div>
                    <div class="pill-item"><div class="pill-icon"><i class="fas fa-bug"></i></div> <span id="val-soil">Suelo Vivo</span></div>
                </div>
            </div>

            <div class="card-title" style="margin-top:20px;"><span>IMPACTO VISUAL</span> <i class="fas fa-adjust"></i></div>
            <div class="comparison-container">
                <img src="https://images.unsplash.com/photo-1598512752271-33f913a5af13?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="img-comp" alt="Policultivo"> <div class="img-overlay" id="comp-overlay">
                    <img src="https://images.unsplash.com/photo-1508108712903-49b7efd9c36d?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="img-comp" style="width:200%; max-width:none;" alt="Monocultivo"> <div class="comp-label left">MONOCULTIVO</div>
                </div>
                <div class="comp-label right">POLICULTIVO (ACTUAL)</div>
                <input type="range" min="0" max="100" value="50" class="slider-range" oninput="updateComparison(this.value)">
            </div>

            <button class="btn-action btn-primary" onclick="openRadar()">
                <i class="fas fa-satellite-dish"></i> INICIAR ESCANEO BIO
            </button>
            <button class="btn-action btn-secondary" onclick="alert('Descargando certificado blockchain...')">
                <i class="fas fa-file-contract"></i> VER CERTIFICADO
            </button>
        </div>
    </div>

    <div class="modal" id="radar-modal">
        <div class="modal-content">
            <h2 style="font-family:'Cinzel'; color:var(--primary);">MONITOREO SATELITAL</h2>
            <div class="radar-box">
                <div class="radar-scan"></div>
                <i class="fas fa-paw" style="position:absolute; top:30%; left:60%; color:var(--text-main); font-size:1.2rem; opacity:0;" id="radar-blip"></i>
            </div>
            <div style="margin-top:20px; text-align:center;">
                <p style="color:var(--secondary); font-size:1.2rem; font-weight:bold;" id="radar-status">ESCANANDO...</p>
                <div style="font-size:0.8rem; color:#888;">Frecuencia: 142.5 Mhz | Cobertura: 100%</div>
            </div>
            <button class="btn-action btn-secondary" style="margin-top:30px; width:auto; padding:10px 40px;" onclick="closeRadar()">CERRAR</button>
        </div>
    </div>

    <script>
        // --- DATASET: TIERRA DE AGAVES ---
        const locations = [
            {
                name: "San Juan Lechigalla",
                cat: "AGROFORESTERÍA",
                coords: [16.635, -96.155],
                desc: "Aquí el Agave Espadín no crece solo. Convive con maíz, frijol y árboles de Huizache que fijan nitrógeno al suelo, evitando la erosión típica del monocultivo.",
                audio: "La Milpa Diversa",
                stats: { water: "Retención Media", veg: "Cobertura 65%", fauna: "Polinizadores", soil: "Nutrientes Altos" }
            },
            {
                name: "Sta. María Zoquitlán",
                cat: "ZONA NÚCLEO",
                coords: [16.565, -96.355],
                desc: "Santuario del Jaguar. 300 hectáreas de selva baja caducifolia estrictamente protegidas. Prohibida la extracción, permitida la admiración.",
                audio: "El Rugido del Monte",
                stats: { water: "Manantiales", veg: "Cobertura 98%", fauna: "Jaguar / Puma", soil: "Intacto" }
            },
            {
                name: "San Bartolo Yautepec",
                cat: "PRODUCCIÓN LIMPIA",
                coords: [16.450, -96.000],
                desc: "El vinazas (residuos líquidos) no van al río. Se tratan en biodigestores para generar gas que alimenta el siguiente horno de cocción.",
                audio: "Río Cristalino",
                stats: { water: "Tratamiento 100%", veg: "Ribereña", fauna: "Iguana Negra", soil: "Compostaje" }
            }
        ];

        let currentIdx = 0;
        let isWetSeason = true;
        let isDockOpen = false;

        // --- MAPA LEAFLET ---
        const map = L.map('map', { 
            zoomControl: false, 
            attributionControl: false,
            zoomSnap: 0.5 
        }).setView([16.6, -96.2], 10);

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18
        }).addTo(map);

        // Marcadores personalizados
        locations.forEach((loc, idx) => {
            const iconHtml = `<div style="width:16px; height:16px; background:var(--accent); border-radius:50%; box-shadow:0 0 0 4px rgba(255, 215, 0, 0.3); border:2px solid #000;"></div>`;
            const icon = L.divIcon({ className: 'custom-pin', html: iconHtml });
            
            L.marker(loc.coords, {icon: icon}).addTo(map).on('click', () => {
                updateContent(idx);
                openDock();
            });
        });

        // --- FUNCIONES DE UI ---

        // 1. Init Sequence (Fake Scanner)
        window.onload = () => {
            const tl = gsap.timeline();
            
            // Texto dinámico
            setTimeout(() => { document.getElementById('scan-text').innerHTML = "<p>BOTELLA: TOBALÁ<br>LOTE: BTS-042</p>"; document.getElementById('scan-text').style.opacity = 1; }, 1000);
            setTimeout(() => { document.getElementById('scan-text').innerHTML = "<p style='color:white'>ORIGEN CONFIRMADO<br>OAXACA, MÉXICO</p>"; }, 2500);

            // Transición a Mapa
            tl.to("#ar-overlay", { duration: 0.5, delay: 3.5, opacity: 0, display: "none" })
              .from("#map-container", { duration: 1.5, scale: 1.2, ease: "power2.out" }, "-=0.2")
              .from(".smart-dock", { duration: 0.8, y: 100, opacity: 0 }, "-=1")
              .add(() => animateCounter());
            
            updateContent(0);
        };

        // 2. Control del Dock
        function toggleDock() {
            const dock = document.getElementById('dock');
            isDockOpen = !isDockOpen;
            if(isDockOpen) dock.classList.add('expanded');
            else dock.classList.remove('expanded');
        }
        function openDock() {
            if(!isDockOpen) toggleDock();
        }

        // 3. Actualizar Contenido
        function updateContent(idx) {
            currentIdx = idx;
            const data = locations[idx];
            
            // Animación de textos
            gsap.fromTo("#d-name", {opacity:0, y:10}, {opacity:1, y:0, duration:0.4});
            
            document.getElementById('d-cat').innerText = data.cat;
            document.getElementById('d-name').innerText = data.name;
            document.getElementById('d-desc').innerText = data.desc;
            document.getElementById('d-audio').innerText = data.audio;
            
            // Stats
            document.getElementById('val-water').innerText = data.stats.water;
            document.getElementById('val-veg').innerText = data.stats.veg;
            document.getElementById('val-fauna').innerText = data.stats.fauna;
            document.getElementById('val-soil').innerText = data.stats.soil;

            // Vuelo del mapa
            map.flyTo(data.coords, 14, { duration: 2, ease: "power2.inOut" });
        }

        function changeLocation(dir) {
            let next = currentIdx + dir;
            if(next >= locations.length) next = 0;
            if(next < 0) next = locations.length - 1;
            updateContent(next);
        }

        // 4. Temporada (Filtros CSS)
        function toggleSeason() {
            isWetSeason = !isWetSeason;
            const btn = document.getElementById('season-btn');
            const icon = document.getElementById('season-icon');
            const txt = document.getElementById('season-txt');
            
            if(isWetSeason) {
                document.body.className = "season-wet";
                icon.className = "fas fa-cloud-showers-heavy";
                txt.innerText = "LLUVIAS";
                btn.classList.remove("active");
            } else {
                document.body.className = "season-dry";
                icon.className = "fas fa-sun";
                txt.innerText = "SECAS";
                btn.classList.add("active");
                // Haptic feedback simulado
                if(navigator.vibrate) navigator.vibrate(50);
            }
        }

        // 5. Comparador Slider
        function updateComparison(val) {
            const overlay = document.getElementById('comp-overlay');
            overlay.style.width = val + "%";
        }

        // 6. Radar Logica
        function openRadar() {
            const modal = document.getElementById('radar-modal');
            modal.classList.add('active');
            
            // Simular hallazgo
            setTimeout(() => {
                const blip = document.getElementById('radar-blip');
                const status = document.getElementById('radar-status');
                gsap.to(blip, { opacity: 1, scale: 1.5, duration: 0.2, yoyo: true, repeat: 3 });
                status.innerText = "¡FAUNA DETECTADA!";
                status.style.color = "var(--accent)";
                if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }, 2000);
        }
        function closeRadar() {
            document.getElementById('radar-modal').classList.remove('active');
            document.getElementById('radar-status').innerText = "ESCANANDO...";
            document.getElementById('radar-status').style.color = "var(--secondary)";
            document.getElementById('radar-blip').style.opacity = 0;
        }

        // 7. Animación de Números
        function animateCounter() {
            const counters = document.querySelectorAll('.counter');
            counters.forEach(counter => {
                const target = +counter.getAttribute('data-target');
                const updateCount = () => {
                    const count = +counter.innerText;
                    const inc = target / 100;
                    if (count < target) {
                        counter.innerText = Math.ceil(count + inc);
                        setTimeout(updateCount, 20);
                    } else {
                        counter.innerText = target.toLocaleString();
                    }
                };
                updateCount();
            });
        }
        
        // Audio Toggle simple
        let isPlaying = false;
        function playAudio() {
            isPlaying = !isPlaying;
            const icon = document.getElementById('play-icon');
            icon.className = isPlaying ? "fas fa-pause" : "fas fa-play";
        }

    </script>
</body>
</html>
